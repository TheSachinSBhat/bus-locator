{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<div class="jumbotron text-center">
  <div class="container">
    <a href="/" class="lang-logo">
      <img src="{% static 'lang-logo.png'%}">
    </a>
    <h1>Bus Locator App</h1>
    <p>Track local city bus locations in real-time</p>
   </div>
</div>
<div class="container">
  <hr>
    <div>
        <label>User Location</label>
        <div id="user-location-div">
            <div id="startLat"></div>
            <div id="startLon"></div>
        </div>
    </div>
	<div id="googleMap" style="width:1200px;height:600px;"></div>
	<script>
		/* Represents the Map object */
		var map;

		/* Object that represents Custom Bus Marker */
		var busMarker;

		var busLocation = new google.maps.LatLng(18.52592091234, 73.82753751221);

		/* Represents the user location */
		var USER_LOCATION;

		/* Method that initializes the Map Object */
		function initialize() {
			debugger;
			/* Stores the map properties */
			var mapProp = {
				center: new google.maps.LatLng(18.52592091234, 73.82753751221),
				zoom: 18,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};


			map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

			/* Add a custom marker on the map */
			busMarker = new google.maps.Marker({
				position: busLocation,
				icon: "{% static 'bus_18_2x.png'%}",
				map: map
			});

		}

		/* Event listener for Window Load event */
		google.maps.event.addDomListener(window, 'load', initialize);

		/* Update the location of the Bus Marker */
		window.setInterval(function () {
			debugger;
			/* Get Bus Location Co-ordinates */
			busLocation = getNewCoordinate(busLocation, -10, 0);
			busMarker.setPosition(busLocation);

			/* Get User Location Co-ordinates */
			getUserLocation();

			google.maps.event.trigger(map, 'resize');
		}, 1000);


		/* Method that returns location co-ordinates of the user */
		function getUserLocation() {
			getLocation();
		}

		/* Method that updates the user's current location */
		function updateUserLocation() {
			document.getElementById('startLat').innerHTML = USER_LOCATION.coords.latitude;
			document.getElementById('startLon').innerHTML = USER_LOCATION.coords.longitude;

			// TODO: Update user location on map
		}

		/***** Generic Functions *****/

		/* Get the current location using HTML5 Geolocation */
		/* Reference: http://www.w3schools.com/html/html5_geolocation.asp */
		function getLocation() {
			if (navigator.geolocation) {
				//navigator.geolocation.getCurrentPosition(showPosition);
				navigator.geolocation.getCurrentPosition(geoSuccess, geoError, geoOptions);
			} else {
				userLocationDiv.val("Geolocation is not supported by this browser.");
			}
		}

		var geoOptions = {
			timeout: 10 * 1000
		}

		var geoSuccess = function (position) {
			startPos = position;

			/* Update user's location */
			USER_LOCATION = new google.maps.LatLng(startPos.coords.latitude, startPos.coords.longitude);
			updateUserLocation();
		};

		var geoError = function (error) {
			console.log('Error occurred. Error code: ' + error.code);
			// error.code can be:
			//   0: unknown error
			//   1: permission denied
			//   2: position unavailable (error response from location provider)
			//   3: timed out
		};

		/* Method that returns new co-ordinates based on the north and east offsets passed */
		function getNewCoordinate(position, northOffset, eastOffset) {

			/* Position, decimal degrees */
			var latitude = position.lat();
			var longitude = position.lng();

			/* Earths radius, sphere */
			R = 6378137

			/* PI Value */
			PI = 3.14159265

			/* offsets in meters */
			dn = northOffset
			de = eastOffset

			/* Coordinate offsets in radians */
			dLat = dn / R
			dLon = de / (R * Math.cos(PI * latitude / 180))

			/* OffsetPosition, decimal degrees */
			newlatitude = latitude + dLat * 180 / PI
			newlongitude = longitude + dLon * 180 / PI

			var newLocation = new google.maps.LatLng(newlatitude, newlongitude);
			return newLocation;
		}

	</script>
</div>
{% endblock %}